{% extends 'base/base.html' %}
{% load static %}

{% block title %}Application {{ application.application_number }} - National ID Management System{% endblock %}

{% block content %}
<div class="message-container" id="system-messages">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        <i class="bi {% if message.tags == 'success' %}bi-check-circle{% else %}bi-exclamation-triangle{% endif %} me-2"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>

<div class="pagetitle">
    <h1><i class="bi bi-card-text me-2"></i>Application Details</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="#"><i class="bi bi-house-door"></i> Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'applications_list' %}">ID Applications</a></li>
            <li class="breadcrumb-item active">{{ application.application_number }}</li>
        </ol>
    </nav>
</div>

<section class="section">
    <div class="row">
        <!-- Application Info -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h6 style='color: white'class="mb-0"><i class="bi bi-person me-2"></i>Basic Information</h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="avatar avatar-xl bg-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 80px; height: 80px;">
                            <i class="bi bi-person text-white" style="font-size: 2.5rem;"></i>
                        </div>
                        <h5>{{ application.full_name }}</h5>
                        <span class="badge 
                            {% if application.status == 'started' or application.status == 'documents_uploaded' %}bg-secondary
                            {% elif application.status == 'chief_review' or application.status == 'do_review' %}bg-warning
                            {% elif application.status == 'chief_approved' or application.status == 'do_approved' %}bg-success
                            {% elif application.status == 'ready_for_collection' %}bg-info
                            {% elif application.status == 'collected' %}bg-primary
                            {% elif application.status == 'rejected' or application.status == 'cancelled' %}bg-danger
                            {% else %}bg-light text-dark{% endif %}">
                            {{ application.get_status_display }}
                        </span>
                    </div>
                    <hr>
                    <div class="row g-2">
                        <div class="col-12">
                            <p><strong><i class="bi bi-hash me-2"></i>Application #:</strong><br>{{ application.application_number }}</p>
                        </div>
                        <div class="col-12">
                            <p><strong><i class="bi bi-card-checklist me-2"></i>Type:</strong><br>
                                <span class="badge {% if application.application_type == 'new' %}bg-success{% elif application.application_type == 'replacement' %}bg-warning{% else %}bg-info{% endif %}">
                                    {{ application.get_application_type_display }}
                                </span>
                            </p>
                        </div>
                        <div class="col-12">
                            <p><strong><i class="bi bi-door-open me-2"></i>Entry Point:</strong><br>{{ application.get_entry_point_display }}</p>
                        </div>
                        <div class="col-12">
                            <p><strong><i class="bi bi-calendar me-2"></i>Date of Birth:</strong><br>{{ application.date_of_birth|date:"F d, Y" }}</p>
                        </div>
                        <div class="col-12">
                            <p><strong><i class="bi bi-geo-alt me-2"></i>Birth Place:</strong><br>{{ application.place_of_birth }}</p>
                        </div>
                        <div class="col-12">
                            <p><strong><i class="bi bi-person-badge me-2"></i>Gender:</strong><br>{{ application.get_gender_display }}</p>
                        </div>
                    </div>
                    
                    <hr>
                    <div class="d-grid gap-2">
                        <a href="{% url 'applications_update' application.application_id %}" class="btn btn-primary">
                            <i class="bi bi-pencil me-2"></i>Edit Application
                        </a>
                        <a href="{% url 'applications_delete' application.application_id %}" class="btn btn-outline-danger">
                            <i class="bi bi-trash me-2"></i>Delete Application
                        </a>
                        <a href="{% url 'applications_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Back to List
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact & Family Information -->
        <div class="col-lg-8">
            <div class="row">
                <!-- Contact Information -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-telephone me-2"></i>Contact Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Phone:</strong> {{ application.phone_number }}</p>
                                    <p><strong>Alternative Phone:</strong> {{ application.alternative_phone|default:"Not provided" }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Email:</strong> {{ application.email|default:"Not provided" }}</p>
                                    <p><strong>Postal Address:</strong> {{ application.postal_address|default:"Not provided" }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Family Information -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-people me-2"></i>Family Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Father:</strong> {{ application.father_name|default:"Not provided" }}</p>
                                    <p><strong>Father ID:</strong> {{ application.father_id|default:"Not provided" }}</p>
                                    <p><strong>Mother:</strong> {{ application.mother_name|default:"Not provided" }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Mother ID:</strong> {{ application.mother_id|default:"Not provided" }}</p>
                                    <p><strong>Guardian:</strong> {{ application.guardian_name|default:"Not applicable" }}</p>
                                    <p><strong>Clan:</strong> {{ application.clan_name|default:"Not specified" }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Location Information -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-geo me-2"></i>Location Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-muted">Birth Location</h6>
                                    <p><strong>County:</strong> {{ application.county_of_birth.name }}</p>
                                    <p><strong>Sub County:</strong> {{ application.sub_county_of_birth.name }}</p>
                                    <p><strong>Division:</strong> {{ application.division_of_birth.name }}</p>
                                    <p><strong>Location:</strong> {{ application.location_of_birth.name }}</p>
                                    <p><strong>Sub Location:</strong> {{ application.sub_location_of_birth.name }}</p>
                                    <p><strong>Village:</strong> {{ application.village_of_birth.name }}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted">Current Address</h6>
                                    <p><strong>County:</strong> {{ application.current_county.name }}</p>
                                    <p><strong>Sub County:</strong> {{ application.current_sub_county.name }}</p>
                                    <p><strong>Division:</strong> {{ application.current_division.name }}</p>
                                    <p><strong>Location:</strong> {{ application.current_location.name }}</p>
                                    <p><strong>Sub Location:</strong> {{ application.current_sub_location.name }}</p>
                                    <p><strong>Village:</strong> {{ application.current_village.name }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Information for Replacement/Name Change -->
                {% if application.application_type == 'replacement' %}
                <div class="col-12">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="bi bi-arrow-repeat me-2"></i>Replacement Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Previous ID Number:</strong> {{ application.previous_id_number|default:"Not provided" }}</p>
                                    <p><strong>Replacement Reason:</strong> {{ application.get_replacement_reason_display|default:"Not specified" }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Police OB Number:</strong> {{ application.police_ob_number|default:"Not provided" }}</p>
                                    <p><strong>Police Station:</strong> {{ application.police_station|default:"Not provided" }}</p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Replacement Fee:</strong> KES {{ application.replacement_fee }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Fee Status:</strong> 
                                        <span class="badge {% if application.fee_paid %}bg-success{% else %}bg-warning{% endif %}">
                                            {% if application.fee_paid %}Paid{% else %}Pending{% endif %}
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if application.application_type == 'name_change' %}
                <div class="col-12">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="bi bi-person-lines-fill me-2"></i>Name Change Details</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Old Name:</strong> {{ application.old_name|default:"Not provided" }}</p>
                            <p><strong>New Name:</strong> {{ application.new_name|default:"Not provided" }}</p>
                            <p><strong>Reason for Change:</strong> {{ application.name_change_reason|default:"Not provided" }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Processing Information -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-building me-2"></i>Processing Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Birth Certificate:</strong> {{ application.birth_certificate.certificate_number }}</p>
                                    <p><strong>Chief Office:</strong> {{ application.chief_office.name|default:"Not assigned" }}</p>
                                    <p><strong>DO Office:</strong> {{ application.do_office.name|default:"Not assigned" }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Huduma Centre:</strong> {{ application.huduma_centre.name|default:"Not assigned" }}</p>
                                    <p><strong>Created:</strong> {{ application.created_at|date:"F d, Y \a\\t g:i A" }}</p>
                                    <p><strong>Last Updated:</strong> {{ application.updated_at|date:"F d, Y \a\\t g:i A" }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status History and Documents Section -->
    <div class="row mt-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Status History</h6>
                </div>
                <div class="card-body">
                    {% for history in status_history %}
                    <div class="d-flex mb-3">
                        <div class="flex-shrink-0">
                            <div class="avatar avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center">
                                <i class="bi bi-arrow-right text-white"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">{{ history.get_new_status_display }}</h6>
                            <p class="text-muted mb-1">{{ history.timestamp|date:"F d, Y \a\\t g:i A" }}</p>
                            <p class="text-muted mb-0">Changed by: {{ history.changed_by.get_full_name|default:history.changed_by.username }}</p>
                            {% if history.change_reason %}
                            <p class="text-muted mb-0">Reason: {{ history.change_reason }}</p>
                            {% endif %}
                            {% if history.notes %}
                            <p class="text-muted mb-0">Notes: {{ history.notes }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No status history available.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Documents</h6>
                </div>
                <div class="card-body">
                    {% for app_doc in app_documents %}
                    <div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded">
                        <div>
                            <h6 class="mb-1">{{ app_doc.document_type.name }}</h6>
                            <p class="text-muted mb-0">{{ app_doc.document.document_number|default:"No document number" }}</p>
                        </div>
                        <div class="text-end">
                            <span class="badge {% if app_doc.is_verified %}bg-success{% elif app_doc.is_provided %}bg-warning{% else %}bg-secondary{% endif %}">
                                {% if app_doc.is_verified %}Verified{% elif app_doc.is_provided %}Provided{% else %}Pending{% endif %}
                            </span>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No documents uploaded yet.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications and Payments Section -->
    <div class="row mt-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-bell me-2"></i>Notifications</h6>
                </div>
                <div class="card-body">
                    {% for notification in notifications|slice:":5" %}
                    <div class="d-flex mb-3">
                        <div class="flex-shrink-0">
                            <div class="avatar avatar-sm bg-{% if notification.status == 'sent' %}success{% elif notification.status == 'failed' %}danger{% else %}warning{% endif %} rounded-circle d-flex align-items-center justify-content-center">
                                <i class="bi bi-{% if notification.notification_type == 'sms' %}phone{% elif notification.notification_type == 'email' %}envelope{% else %}bell{% endif %} text-white"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">{{ notification.get_notification_type_display }} - {{ notification.get_status_display }}</h6>
                            <p class="text-muted mb-1">{{ notification.created_at|date:"F d, Y \a\\t g:i A" }}</p>
                            <p class="mb-0">{{ notification.message|truncatechars:100 }}</p>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No notifications sent yet.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-credit-card me-2"></i>Payments</h6>
                </div>
                <div class="card-body">
                    {% for payment in payments %}
                    <div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded">
                        <div>
                            <h6 class="mb-1">{{ payment.fee.get_fee_type_display }}</h6>
                            <p class="text-muted mb-0">{{ payment.payment_reference }} - {{ payment.get_payment_method_display }}</p>
                        </div>
                        <div class="text-end">
                            <p class="mb-0 fw-bold">KES {{ payment.amount }}</p>
                            <span class="badge {% if payment.status == 'completed' %}bg-success{% elif payment.status == 'failed' %}bg-danger{% else %}bg-warning{% endif %}">
                                {{ payment.get_status_display }}
                            </span>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No payments recorded yet.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}