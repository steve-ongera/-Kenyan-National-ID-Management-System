{% extends 'base/base.html' %}
{% load static %}

{% block title %}Waiting Card - {{ waiting_card.serial_number }} - National ID Management System{% endblock %}

{% block extra_css %}
<style>
.waiting-card {
    width: 85mm;
    height: 54mm;
    border: 2px solid #0066cc;
    border-radius: 8px;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    position: relative;
    font-family: 'Arial', sans-serif;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    margin: 0 auto;
    overflow: hidden;
}

.card-header-stripe {
    background: linear-gradient(90deg, #0066cc 0%, #0052a3 100%);
    height: 8mm;
    position: relative;
}

.card-title {
    color: white;
    text-align: center;
    padding-top: 1.5mm;
    font-size: 3.5mm;
    font-weight: bold;
    letter-spacing: 0.5px;
}

.kenya-flag {
    position: absolute;
    right: 2mm;
    top: 1mm;
    width: 8mm;
    height: 5mm;
    background: linear-gradient(to bottom, 
        #000000 0%, #000000 25%, 
        #ff0000 25%, #ff0000 50%, 
        #ffffff 50%, #ffffff 75%, 
        #00ff00 75%, #00ff00 100%);
    border: 0.5px solid #ccc;
    border-radius: 1px;
}

.card-body {
    padding: 2mm;
    height: calc(54mm - 16mm);
    position: relative;
}

.applicant-info {
    margin-bottom: 2mm;
}

.field-label {
    font-size: 2.2mm;
    color: #0066cc;
    font-weight: bold;
    text-transform: uppercase;
    margin: 0;
    line-height: 1.1;
}

.field-value {
    font-size: 2.5mm;
    color: #333;
    font-weight: 600;
    margin: 0;
    line-height: 1.2;
    margin-bottom: 1.5mm;
}

.application-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1mm;
    margin-bottom: 2mm;
}

.qr-section {
    position: absolute;
    bottom: 2mm;
    right: 2mm;
    text-align: center;
}

.qr-code {
    width: 12mm;
    height: 12mm;
    border: 1px solid #ddd;
}

.qr-label {
    font-size: 1.8mm;
    color: #666;
    margin-top: 0.5mm;
}

.collection-info {
    border-top: 1px dashed #0066cc;
    padding-top: 1.5mm;
    margin-top: 1mm;
}

.serial-number {
    position: absolute;
    bottom: 0.5mm;
    left: 2mm;
    font-size: 2mm;
    color: #666;
    font-family: 'Courier New', monospace;
}

.watermark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-45deg);
    font-size: 8mm;
    color: rgba(0, 102, 204, 0.05);
    font-weight: bold;
    z-index: 1;
    pointer-events: none;
}

.card-back {
    margin-top: 20px;
    background: #f8f9fa;
    border: 2px solid #0066cc;
    border-radius: 8px;
    padding: 3mm;
    width: 85mm;
    margin: 20px auto 0;
}

.instructions-title {
    font-size: 3mm;
    font-weight: bold;
    color: #0066cc;
    text-align: center;
    margin-bottom: 2mm;
    text-transform: uppercase;
}

.instructions-text {
    font-size: 2.2mm;
    line-height: 1.4;
    color: #333;
}

.print-controls {
    text-align: center;
    margin: 20px 0;
}

@media print {
    .no-print {
        display: none !important;
    }
    
    .waiting-card, .card-back {
        box-shadow: none;
        page-break-inside: avoid;
    }
    
    body {
        background: white;
    }
}

.status-badge {
    position: absolute;
    top: 1mm;
    left: 2mm;
    background: #28a745;
    color: white;
    padding: 0.5mm 1mm;
    font-size: 1.8mm;
    border-radius: 2px;
    font-weight: bold;
}

.verification-strip {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 1.5mm;
    background: linear-gradient(90deg, #0066cc 0%, #00aa44 50%, #ff6600 100%);
}
</style>
{% endblock %}

{% block content %}
<div class="no-print">
    <div class="message-container" id="system-messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
            <i class="bi {% if message.tags == 'success' %}bi-check-circle{% else %}bi-exclamation-triangle{% endif %} me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>

    <div class="pagetitle">
        <h1><i class="bi bi-credit-card-2-back me-2"></i>Waiting Card Details</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#"><i class="bi bi-house-door"></i> Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'waiting_cards_list' %}">Waiting Cards</a></li>
                <li class="breadcrumb-item active">{{ waiting_card.serial_number }}</li>
            </ol>
        </nav>
    </div>
</div>

<section class="section">
    <div class="row">
        <div class="col-12">
            <!-- Action Buttons -->
            <div class="d-flex justify-content-between align-items-center mb-4 no-print">
                <div>
                    <a href="{% url 'waiting_cards_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Back to List
                    </a>
                </div>
                <div>
                    <button onclick="window.print()" class="btn btn-primary">
                        <i class="bi bi-printer me-2"></i>Print Card
                    </button>
                    <a href="{% url 'waiting_card_update' waiting_card.serial_number %}" class="btn btn-outline-primary">
                        <i class="bi bi-pencil me-2"></i>Edit Card
                    </a>
                    <button type="button" class="btn btn-outline-danger" 
                            onclick="confirmDelete('{{ waiting_card.serial_number }}', '{{ waiting_card.application.full_name }}')">
                        <i class="bi bi-trash me-2"></i>Delete
                    </button>
                </div>
            </div>

            <!-- Waiting Card Front -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-credit-card-2-front me-2"></i>Waiting Card (Front)</h5>
                </div>
                <div class="card-body text-center" style="padding: 30px;">
                    <div class="waiting-card">
                        <div class="watermark">KENYA</div>
                        
                        <!-- Card Header -->
                        <div class="card-header-stripe">
                            <div class="card-title">REPUBLIC OF KENYA</div>
                            <div class="kenya-flag"></div>
                        </div>
                        
                        <!-- Status Badge -->
                        <div class="status-badge">
                            {% if waiting_card.is_collected %}COLLECTED{% elif waiting_card.is_active %}ACTIVE{% else %}INACTIVE{% endif %}
                        </div>
                        
                        <!-- Card Body -->
                        <div class="card-body">
                            <!-- Applicant Information -->
                            <div class="applicant-info">
                                <p class="field-label">NATIONAL ID WAITING CARD</p>
                                <p class="field-value">{{ waiting_card.application.full_name|upper }}</p>
                            </div>
                            
                            <!-- Application Details -->
                            <div class="application-details">
                                <div>
                                    <p class="field-label">APP NO:</p>
                                    <p class="field-value" style="font-size: 2.2mm;">{{ waiting_card.application.application_number }}</p>
                                </div>
                                <div>
                                    <p class="field-label">DOB:</p>
                                    <p class="field-value">{{ waiting_card.application.date_of_birth|date:"d/m/Y" }}</p>
                                </div>
                            </div>
                            
                            <!-- Collection Information -->
                            <div class="collection-info">
                                <p class="field-label">COLLECT AT:</p>
                                <p class="field-value" style="font-size: 2.1mm;">{{ waiting_card.collection_location.name|upper }}</p>
                                <p class="field-label">ON:</p>
                                <p class="field-value">{{ waiting_card.expected_collection_date|date:"d/m/Y" }}</p>
                            </div>
                            
                            <!-- QR Code Section -->
                            <div class="qr-section">
                                {% if waiting_card.qr_code %}
                                    <img src="{{ waiting_card.qr_code.url }}" alt="QR Code" class="qr-code">
                                {% else %}
                                    <div class="qr-code" style="background: #f8f9fa; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; font-size: 1.8mm; color: #666;">
                                        NO QR
                                    </div>
                                {% endif %}
                                <p class="qr-label">SCAN ME</p>
                            </div>
                            
                            <!-- Serial Number -->
                            <div class="serial-number">{{ waiting_card.serial_number }}</div>
                            
                            <!-- Verification Strip -->
                            <div class="verification-strip"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Waiting Card Back -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-credit-card-2-back me-2"></i>Waiting Card (Back)</h5>
                </div>
                <div class="card-body text-center" style="padding: 30px;">
                    <div class="card-back">
                        <div class="instructions-title">COLLECTION INSTRUCTIONS</div>
                        <div class="instructions-text">
                            {{ waiting_card.collection_instructions|default:"Please bring this waiting card and your original birth certificate when collecting your National ID. Ensure you arrive during office hours and carry a valid form of identification." }}
                        </div>
                        
                        <div style="margin-top: 3mm; padding-top: 2mm; border-top: 1px dashed #0066cc;">
                            <div class="field-label">CONTACT INFORMATION:</div>
                            <div style="font-size: 2.2mm; line-height: 1.3; color: #333;">
                                <strong>{{ waiting_card.collection_location.name }}</strong><br>
                                {{ waiting_card.collection_location.address }}<br>
                                Phone: {{ waiting_card.collection_location.contact_phone }}<br>
                                {% if waiting_card.collection_location.email %}Email: {{ waiting_card.collection_location.email }}{% endif %}
                            </div>
                        </div>
                        
                        <div style="margin-top: 3mm; font-size: 1.8mm; color: #666; text-align: center;">
                            Issued: {{ waiting_card.issued_at|date:"d/m/Y H:i" }}<br>
                            Valid until ID collection • Keep this card safe
                        </div>
                    </div>
                </div>
            </div>

            <!-- Application Details (No Print) -->
            <div class="card border-0 shadow-sm mt-4 no-print">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Application Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th width="40%">Application Number:</th>
                                    <td><span class="badge bg-primary">{{ waiting_card.application.application_number }}</span></td>
                                </tr>
                                <tr>
                                    <th>Application Type:</th>
                                    <td>{{ waiting_card.application.get_application_type_display }}</td>
                                </tr>
                                <tr>
                                    <th>Current Status:</th>
                                    <td>
                                        <span class="badge bg-{% if waiting_card.application.status == 'biometrics_taken' %}success{% elif waiting_card.application.status == 'processing' %}warning{% else %}secondary{% endif %}">
                                            {{ waiting_card.application.get_status_display }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Applicant:</th>
                                    <td>{{ waiting_card.application.applicant.get_full_name|default:waiting_card.application.applicant.username }}</td>
                                </tr>
                                <tr>
                                    <th>Phone Number:</th>
                                    <td>{{ waiting_card.application.phone_number }}</td>
                                </tr>
                                <tr>
                                    <th>Birth Certificate:</th>
                                    <td>{{ waiting_card.application.birth_certificate.certificate_number }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th width="40%">Serial Number:</th>
                                    <td><strong>{{ waiting_card.serial_number }}</strong></td>
                                </tr>
                                <tr>
                                    <th>Expected Collection:</th>
                                    <td>{{ waiting_card.expected_collection_date|date:"F d, Y" }}</td>
                                </tr>
                                <tr>
                                    <th>Collection Location:</th>
                                    <td>{{ waiting_card.collection_location.name }}</td>
                                </tr>
                                <tr>
                                    <th>Is Active:</th>
                                    <td>
                                        <span class="badge {% if waiting_card.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if waiting_card.is_active %}Active{% else %}Inactive{% endif %}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Is Collected:</th>
                                    <td>
                                        <span class="badge {% if waiting_card.is_collected %}bg-primary{% else %}bg-warning{% endif %}">
                                            {% if waiting_card.is_collected %}Collected{% else %}Pending Collection{% endif %}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Issued At:</th>
                                    <td>{{ waiting_card.issued_at|date:"F d, Y H:i" }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    {% if waiting_card.application.biometric_data %}
                    <div class="mt-3">
                        <h6>Biometric Data Status:</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <small class="text-muted">Photo Quality:</small><br>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" role="progressbar" style="width: {{ waiting_card.application.biometric_data.photo_quality_score }}%">
                                        {{ waiting_card.application.biometric_data.photo_quality_score }}%
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Fingerprint Quality:</small><br>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" role="progressbar" style="width: {{ waiting_card.application.biometric_data.fingerprint_quality_score }}%">
                                        {{ waiting_card.application.biometric_data.fingerprint_quality_score }}%
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Signature Quality:</small><br>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" role="progressbar" style="width: {{ waiting_card.application.biometric_data.signature_quality_score }}%">
                                        {{ waiting_card.application.biometric_data.signature_quality_score }}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the waiting card for <strong id="cardHolder"></strong>?</p>
                <p class="text-danger">This action cannot be undone and may affect the applicant's ability to collect their ID.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Waiting Card</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function confirmDelete(serialNumber, cardHolder) {
    document.getElementById('cardHolder').textContent = cardHolder;
    document.getElementById('deleteForm').action = `/waiting-cards/${serialNumber}/delete/`;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}
</script>
{% endblock %}